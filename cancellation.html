<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Pembatalan Pemesanan Hotel</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <a href="index.html" class="link-button inline-block mb-6">‚Üê Kembali ke Beranda</a>

        <h1 class="text-2xl font-bold mb-2 text-center">Analisis Pembatalan Pemesanan Hotel</h1>
        <h2 class="text-lg mb-6 text-center text-gray-600 italic">Faktor-faktor yang Memengaruhi Tingkat Pembatalan</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="chart-container">
                <h3 class="text-lg font-bold mb-4">Persentase Pembatalan Pemesanan</h3>
                <div id="pie-chart" class="h-64"></div>
            </div>

            <div class="chart-container">
                <h3 class="text-lg font-bold mb-4">Persentase Pembatalan berdasarkan Jenis Hotel</h3>
                <div id="hotel-chart" class="h-64"></div>
            </div>

            <div class="chart-container">
                <h3 class="text-lg font-bold mb-4">Persentase Pembatalan berdasarkan Lead Time</h3>
                <div id="lead-time-chart" class="h-64"></div>
            </div>

            <div class="chart-container">
                <h3 class="text-lg font-bold mb-4">Persentase Pembatalan berdasarkan Tipe Deposit</h3>
                <div id="deposit-chart" class="h-64"></div>
            </div>
        </div>

        <div class="mt-6 text-center">
            <div class="p-4 bg-gray-100 rounded-lg inline-block">
                <p class="text-sm">Intensitas warna merah menunjukkan tingkat pembatalan: semakin gelap, semakin tinggi
                    tingkat pembatalan</p>
            </div>
        </div>

        <div class="mt-4 text-center">
            <div class="p-4 bg-gray-100 rounded-lg inline-block">
                <p id="caption-text" class="text-sm"></p>
            </div>
        </div>

        <div id="loading" class="text-center p-6 my-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuat data...</p>
        </div>

        <div class="mt-8 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-3">Insight</h2>
            <div id="insight" class="text-gray-700">
                <p><span class="font-semibold">1.</span> <span id="cancel-percentage"
                        class="font-semibold text-red-600"></span>% dari total pemesanan dibatalkan, menunjukkan tingkat
                    pembatalan yang cukup tinggi.</p>
                <p><span class="font-semibold">2.</span> City Hotel memiliki tingkat pembatalan lebih tinggi (<span
                        id="city-cancel" class="font-semibold text-red-600"></span>%) dibandingkan Resort Hotel (<span
                        id="resort-cancel" class="font-semibold text-red-600"></span>%).</p>
                <p><span class="font-semibold">3.</span> Terdapat korelasi positif antara lead time dan tingkat
                    pembatalan. Pemesanan dengan lead time <span id="highest-lead-time" class="font-semibold"></span>
                    memiliki tingkat pembatalan tertinggi (<span id="lead-time-percent"
                        class="font-semibold text-red-600"></span>%).</p>
                <p><span class="font-semibold">4.</span> Pemesanan dengan tipe deposit '<span id="highest-deposit"
                        class="font-semibold"></span>' memiliki tingkat pembatalan sangat tinggi (<span
                        id="deposit-percent" class="font-semibold text-red-600"></span>%), meskipun jumlahnya relatif
                    kecil.</p>
                <p><span class="font-semibold">5.</span> Tingkat pembatalan untuk tipe deposit lainnya: <span
                        id="other-deposits" class="font-semibold"></span>.</p>
                <p><span class="font-semibold">6.</span> Tingkat pembatalan yang tinggi dapat berdampak signifikan pada
                    pendapatan hotel dan perencanaan kapasitas.</p>
                <p><span class="font-semibold">7.</span> Strategi manajemen pembatalan yang lebih efektif diperlukan
                    terutama untuk pemesanan dengan lead time panjang.</p>
            </div>
        </div>
    </div>

    <script>
        // Set main colors to match Python visualization
        const main_colors = ["#2C7BB6", "#D7191C", "#1A9641", "#FDAE61", "#FFFFBF", "#9E0142", "#A6761D", "#666666"];

        // Format number with thousands separator
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Function to create horizontal bar chart
        function createHorizontalBarChart(containerId, data, colorScale) {
            // Chart dimensions
            const container = document.getElementById(containerId);
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 20, right: 120, bottom: 50, left: 160 };  // Increased bottom margin for x-axis label
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            // Create SVG
            const svg = d3.select(`#${containerId}`)
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create scales
            const xScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.value) * 1.05])
                .range([0, innerWidth]);

            const yScale = d3.scaleBand()
                .domain(data.map(d => d.category))
                .range([0, innerHeight])
                .padding(0.3);

            // Add axes
            g.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(xScale).ticks(5).tickFormat(d => d + "%"))
                .call(g => g.select(".domain").remove());

            // Add x-axis label
            g.append("text")
                .attr("class", "x-axis-label")
                .attr("x", innerWidth / 2)
                .attr("y", innerHeight + 40)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "#666")
                .text("Persentase Pembatalan (%)");

            // Add y-axis label
            g.append("text")
                .attr("class", "y-axis-label")
                .attr("transform", "rotate(-90)")
                .attr("x", -innerHeight / 2)
                .attr("y", -120)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "#666")
                .text(containerId === "hotel-chart" ? "Jenis Hotel" : 
                     containerId === "lead-time-chart" ? "Lead Time" :
                     containerId === "deposit-chart" ? "Tipe Deposit" : "");

            g.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(yScale))
                .call(g => g.select(".domain").remove());

            // Add gridlines with more prominent styling
            g.append("g")
                .attr("class", "grid")
                .call(d3.axisBottom(xScale)
                    .ticks(5)
                    .tickSize(-innerHeight)
                    .tickFormat("")
                )
                .call(g => g.select(".domain").remove())
                .style("stroke", "#ddd")  // Darker grid color
                .style("stroke-width", "1px")  // Thicker grid lines
                .style("stroke-opacity", "1");  // Full opacity

            // Add bars
            const bars = g.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("y", d => yScale(d.category))
                .attr("x", 0)
                .attr("height", yScale.bandwidth())
                .attr("width", d => xScale(d.value))
                .attr("fill", d => colorScale(d.value))
                .attr("stroke", "white")
                .attr("stroke-width", "1px");  // Thicker stroke

            // Add label for each bar
            g.selectAll(".bar-label")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "bar-label")
                .attr("x", d => xScale(d.value) + 5)
                .attr("y", d => yScale(d.category) + yScale.bandwidth() / 2)
                .attr("dy", ".35em")
                .style("font-size", "12px")
                .style("fill", "#333")
                .text(d => `${d.value.toFixed(1)}% (${formatNumber(d.count)})`);

            // Update axis styling
            g.select(".x-axis")
                .style("font-size", "12px")
                .style("color", "#666");

            g.select(".y-axis")
                .style("font-size", "12px")
                .style("color", "#666");
        }

        // Function to create pie chart
        function createPieChart(containerId, data) {
            // Chart dimensions
            const container = document.getElementById(containerId);
            const width = container.clientWidth;
            const height = container.clientHeight;
            const radius = Math.min(width, height) / 2 - 40;

            // Create SVG
            const svg = d3.select(`#${containerId}`)
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            const g = svg.append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            // Define colors
            const colors = [main_colors[2], main_colors[1]]; // Green for not canceled, red for canceled

            // Create pie layout
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            // Arc generator
            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            // Slightly larger arc for exploded slice
            const explodedArc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            // Create pie slices
            const slices = g.selectAll(".slice")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "slice");

            slices.append("path")
                .attr("d", arc)
                .attr("class", "pie-slice")
                .attr("fill", (d, i) => colors[i])
                .attr("stroke", "white")
                .attr("stroke-width", 2)
                .attr("transform", (d, i) => {
                    if (i === 1) { // Explode the canceled slice
                        const centroid = arc.centroid(d);
                        const x = centroid[0] * 0.1;
                        const y = centroid[1] * 0.1;
                        return `translate(${x},${y})`;
                    }
                    return "";
                });

            // Add labels with percentages
            slices.append("text")
                .attr("transform", d => {
                    const pos = arc.centroid(d);
                    const midAngle = d.endAngle < Math.PI ? d.startAngle/2 + d.endAngle/2 : d.startAngle/2 + d.endAngle/2 + Math.PI;
                    const x = Math.cos(midAngle) * (radius + 30);
                    const y = Math.sin(midAngle) * (radius + 30);
                    return `translate(${x},${y})`;
                })
                .attr("dy", ".35em")
                .attr("text-anchor", d => {
                    const midAngle = d.endAngle < Math.PI ? d.startAngle/2 + d.endAngle/2 : d.startAngle/2 + d.endAngle/2 + Math.PI;
                    return Math.cos(midAngle) > 0 ? "start" : "end";
                })
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .style("fill", "#333")
                .text(d => `${d.data.label} (${d.data.value.toFixed(1)}%)`);
        }

        // Load and process data
        d3.csv("data/hotel_bookings_processed.csv")
            .then(data => {
                // Hide loading indicator
                document.getElementById('loading').style.display = 'none';

                // ---- PREPARE DATA ----

                // 1. Cancellation counts overall
                const cancellationCounts = d3.rollup(
                    data,
                    v => v.length,
                    d => +d.is_canceled
                );

                const cancellationTotal = Array.from(cancellationCounts.values()).reduce((a, b) => a + b, 0);
                const cancellationPercentages = Array.from(cancellationCounts.entries()).map(([status, count]) => ({
                    label: status === "0" ? "Tidak Dibatalkan" : "Dibatalkan",
                    value: (count / cancellationTotal) * 100,
                    count: count
                }));

                // Sort to ensure "Tidak Dibatalkan" is first, "Dibatalkan" is second
                cancellationPercentages.sort((a, b) => {
                    if (a.label === "Tidak Dibatalkan") return -1;
                    if (b.label === "Tidak Dibatalkan") return 1;
                    return 0;
                });

                // 2. Cancellation by hotel type
                const hotelTypeCounts = d3.rollup(
                    data,
                    v => ({
                        total: v.length,
                        canceled: v.filter(d => +d.is_canceled === 1).length
                    }),
                    d => d.hotel
                );

                const hotelTypeData = Array.from(hotelTypeCounts.entries()).map(([hotel, counts]) => ({
                    category: hotel,
                    value: (counts.canceled / counts.total) * 100,
                    count: counts.canceled
                }));

                // Sort by cancellation rate
                hotelTypeData.sort((a, b) => a.value - b.value);

                // 3. Cancellation by lead time
                const leadTimeCounts = d3.rollup(
                    data,
                    v => ({
                        total: v.length,
                        canceled: v.filter(d => +d.is_canceled === 1).length
                    }),
                    d => d.lead_time_group
                );

                let leadTimeData = Array.from(leadTimeCounts.entries()).map(([leadTime, counts]) => ({
                    category: leadTime,
                    value: (counts.canceled / counts.total) * 100,
                    count: counts.canceled
                }));

                // Sort by cancellation rate
                leadTimeData.sort((a, b) => a.value - b.value);

                // 4. Cancellation by deposit type
                const depositTypeCounts = d3.rollup(
                    data,
                    v => ({
                        total: v.length,
                        canceled: v.filter(d => +d.is_canceled === 1).length
                    }),
                    d => d.deposit_type
                );

                const depositTypeData = Array.from(depositTypeCounts.entries()).map(([depositType, counts]) => ({
                    category: depositType,
                    value: (counts.canceled / counts.total) * 100,
                    count: counts.canceled
                }));

                // Sort by cancellation rate
                depositTypeData.sort((a, b) => a.value - b.value);

                // ---- CREATE VISUALIZATIONS ----

                // Create color scale for bar charts
                const colorScale = d3.scaleSequential()
                    .domain([0, 100])
                    .interpolator(d3.interpolateReds);

                // 1. Create pie chart for overall cancellation
                createPieChart("pie-chart", cancellationPercentages);

                // 2. Create horizontal bar chart for hotel types
                createHorizontalBarChart("hotel-chart", hotelTypeData, colorScale);

                // 3. Create horizontal bar chart for lead time
                createHorizontalBarChart("lead-time-chart", leadTimeData, colorScale);

                // 4. Create horizontal bar chart for deposit types
                createHorizontalBarChart("deposit-chart", depositTypeData, colorScale);

                // Generate caption
                const canceledPercentage = cancellationPercentages.find(d => d.label === "Dibatalkan").value.toFixed(1);
                const cityHotelRate = hotelTypeData.find(d => d.category === "City Hotel").value.toFixed(1);
                const resortHotelRate = hotelTypeData.find(d => d.category === "Resort Hotel").value.toFixed(1);

                // Find highest cancellation rate for lead time
                const highestLeadTime = leadTimeData.slice().sort((a, b) => b.value - a.value)[0];

                // Find highest cancellation rate for deposit type
                const highestDepositType = depositTypeData.slice().sort((a, b) => b.value - a.value)[0];

                const caption = `${canceledPercentage}% dari total pemesanan dibatalkan. City Hotel memiliki tingkat pembatalan lebih tinggi (${cityHotelRate}%) dibandingkan Resort Hotel (${resortHotelRate}%). Pemesanan dengan lead time ${highestLeadTime.category} memiliki tingkat pembatalan tertinggi (${highestLeadTime.value.toFixed(1)}%). Pemesanan dengan tipe deposit '${highestDepositType.category}' memiliki tingkat pembatalan tertinggi (${highestDepositType.value.toFixed(1)}%).`;

                document.getElementById("caption-text").textContent = caption;

                // Update insights
                document.getElementById('cancel-percentage').textContent = canceledPercentage;
                document.getElementById('city-cancel').textContent = cityHotelRate;
                document.getElementById('resort-cancel').textContent = resortHotelRate;
                document.getElementById('highest-lead-time').textContent = highestLeadTime.category;
                document.getElementById('lead-time-percent').textContent = highestLeadTime.value.toFixed(1);
                document.getElementById('highest-deposit').textContent = highestDepositType.category;
                document.getElementById('deposit-percent').textContent = highestDepositType.value.toFixed(1);

                // Prepare string of other deposit types
                const otherDeposits = depositTypeData
                    .filter(d => d.category !== highestDepositType.category)
                    .map(d => `'${d.category}' (${d.value.toFixed(1)}%)`)
                    .join(', ');

                document.getElementById('other-deposits').textContent = otherDeposits;

                // Update data labels to match the image
                const leadTimeMapping = {
                    '0-7 hari': '0-7 hari',
                    '8-30 hari': '8-30 hari',
                    '31-90 hari': '31-90 hari',
                    '91-180 hari': '91-180 hari',
                    '181-365 hari': '181-365 hari',
                    '>365 hari': '>365 hari'
                };

                leadTimeData = leadTimeData.map(d => ({
                    ...d,
                    category: leadTimeMapping[d.category] || d.category
                }));

                // Update deposit type labels
                const depositMapping = {
                    'No Deposit': 'No Deposit',
                    'Non Refund': 'Non Refund',
                    'Refundable': 'Refundable'
                };

                depositTypeData = depositTypeData.map(d => ({
                    ...d,
                    category: depositMapping[d.category] || d.category
                }));
            }).catch(error => {
                console.error("Error loading or processing data:", error);
                document.getElementById('loading').innerHTML = `
                    <div class="p-4 bg-red-100 text-red-700 rounded">
                        <p>Error: Tidak dapat memuat data. Pastikan file CSV tersedia di server.</p>
                        <p>Detail: ${error.message}</p>
                    </div>`;
            });
    </script>
</body>

</html>